name: ie-bank-infra

on:
  workflow_dispatch:
  push:
      paths-ignore:
        - 'scripts/**'
  pull_request:
    branches: [ "main" ]

env:
  RESOURCE_GROUP_DEV: BCSAI2024-DEVOPS-STUDENTS-A-DEV
  RESOURCE_GROUP_UAT: BCSAI2024-DEVOPS-STUDENTS-A-UAT
  RESOURCE_GROUP_PROD: BCSAI2024-DEVOPS-STUDENTS-A-PROD
  SUBSCRIPTION_ID_DEV: e0b9cada-61bc-4b5a-bd7a-52c606726b3b
  USER_ALIAS: devopps-team

jobs:
  # 1. Static Validation Stage
  static-validation:
    name: Static Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Run Bicep Linter
        run: |
          for file in $(find . -name '*.bicep'); do
            echo "Linting $file..."
            az bicep build --file "$file" || exit 1
          done

      - name: Security Scan with Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          framework: bicep

  # 2. Deployment Validation Stage
  deployment-validation:
    name: Deployment Validation
    needs: static-validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Validate Deployment (Dev)
        run: |
          az deployment group validate \
            --resource-group ${{ env.RESOURCE_GROUP_DEV }} \
            --template-file ./main.bicep \
            --parameters ./parameters/dev.bicepparam \
            --location eastus

      - name: Validate Deployment (Min Config)
        run: |
          az deployment group validate \
            --resource-group ${{ env.RESOURCE_GROUP_DEV }} \
            --template-file ./minimal.bicep \
            --location eastus

      - name: Validate Deployment (Max Config)
        run: |
          az deployment group validate \
            --resource-group ${{ env.RESOURCE_GROUP_DEV }} \
            --template-file ./maximal.bicep \
            --location eastus

  # 3. Deploy Dev Environment
  deploy-dev:
    name: Deploy Development Environment
    needs: deployment-validation
    runs-on: ubuntu-latest
    environment:
      name: 'Development'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Dev
        uses: azure/arm-deploy@v2
        with:
          subscriptionId: ${{ env.SUBSCRIPTION_ID_DEV }}
          resourceGroupName: ${{ env.RESOURCE_GROUP_DEV }}
          template: ./main.bicep
          parameters: ./parameters/dev.bicepparam
          deploymentName: ${{ env.USER_ALIAS }}-dev

      - name: Validate Key Vault Exists
        id: validate-keyvault
        run: |
          az keyvault show --name devopps-kv-dev --resource-group ${{ env.RESOURCE_GROUP_DEV }}
        continue-on-error: false

  # 4. Deploy UAT Environment
  deploy-uat:
    name: Deploy UAT Environment
    if: (github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main') || github.ref == 'refs/heads/main'
    needs: deploy-dev
    runs-on: ubuntu-latest
    environment:
      name: 'UAT'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to UAT
        uses: azure/arm-deploy@v2
        with:
          subscriptionId: ${{ env.SUBSCRIPTION_ID_DEV }}
          resourceGroupName: ${{ env.RESOURCE_GROUP_UAT }}
          template: ./main.bicep
          parameters: ./parameters/uat.bicepparam
          deploymentName: ${{ env.USER_ALIAS }}-uat